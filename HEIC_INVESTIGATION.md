# HEIC Support Investigation Report

## Текущий статус
- ✅ **JPG/PNG/WebP/TIFF/BMP/GIF** - полностью работают
- ⚠️ **HEIC/HEIF/AVIF** - обнаружена проблема на уровне системы

## Проблема
При попытке обработать HEIC-файлы с libheif-sys v5.0 возникает ошибка:
```
LoadLibraryA error: 193
```

Ошибка выводится на stderr (не ловится программой) и возникает при вызове функций libheif из Rust.

### Факты:
1. **Windows видит GPS в HEIC-файлах** — свойства файла в Windows Explorer показывают координаты
   - IMG_0279.HEIC: 36°42'18.23..., 30°34'25.69...
   - IMG_0280.HEIC: тот же диапазон

2. **Программа пытается открыть HEIC**, но libheif-sys падает на системном уровне
   - Ошибка 193 (ERROR_INVALID_LEVEL) при LoadLibraryA
   - Это низкоуровневая ошибка DLL загрузки Windows

3. **vcpkg установлен и сконфигурирован**:
   - VCPKG_ROOT = D:\vcpkg
   - VCPKG_DEFAULT_TRIPLET = x64-windows-static
   - Установлены: libheif 1.20.2, libde265 1.0.16, libjpeg-turbo 3.1.2

4. **Попытки решения**:
   - ✅ Использование x64-windows-static triplet (статическая линковка)
   - ✅ Копирование DLL (libde265.dll, jpeg62.dll, turbojpeg.dll) в рабочую директорию
   - ✅ Установка переменных окружения (LIBHEIF_STATIC=1, LIBHEIF_NO_PKG_CONFIG=1)
   - ❌ Ошибка остается

## Гипотезы

### Гипотеза 1: Несовместимость libheif-sys с Windows
- libheif-sys v5.0 может иметь специфичную для Windows проблему с загрузкой

### Гипотеза 2: Проблема с зависимостями внутри libheif
- libde265 может пытаться загружать дополнительные компоненты динамически
- Даже при статической линковке основной код, некоторые функции могут требовать DLL

### Гипотеза 3: Конфликт архитектур или версий
- Возможно, libheif 1.20.2 несовместима с текущей конфигурацией
- Может потребоваться другая версия или сборка из исходников

## Текущее решение

Используется версия **БЕЗ HEIC** (по умолчанию):
- Сборка: `cargo build --release` (без `--features heif`)
- Бинарник: 3.46 МБ
- Работает идеально для JPG, PNG и других стандартных форматов

Версия **С HEIC** доступна:
- Сборка: `cargo build --release --features heif`
- Бинарник: 9.75 МБ
- Компилируется успешно, но при запуске выводит ошибки `LoadLibraryA error: 193`

## Структура кода

### extract_metadata_from_heif() - src/main.rs (lines ~475-550)
Функция извлечения GPS из HEIC-файлов:
```rust
#[cfg(feature = "heif")]
fn extract_metadata_from_heif(path: &Path) -> Result<(f64, f64, String)> {
    // Шаги:
    // 1. heif_context_alloc() - выделяет контекст
    // 2. heif_context_read_from_file() - читает файл
    // 3. heif_context_get_primary_image_handle() - получает изображение
    // 4. heif_image_handle_get_list_of_metadata_block_IDs() - ищет EXIF
    // 5. heif_image_handle_get_metadata() - извлекает EXIF данные
    // 6. exif::Reader::new().read_raw() - парсит EXIF
    // 7. get_gps_coord() - извлекает GPS координаты
}
```

Функция работает логически верно, но ошибка происходит где-то внутри libheif-sys вызовов.

### decode_heif_to_image() - src/main.rs (lines ~551-615)
Декодирование HEIC в DynamicImage для создания миниатюр.

## Возможные направления исследования

1. **Использовать другую версию libheif-sys**
   - Попробовать более старую версию (например, если существует v4.x)
   - Или более новую версию, если она есть

2. **Использовать другую библиотеку для HEIC**
   - `image-heic` (если существует)
   - `heif-rs` (высокоуровневый wrapper)
   - Напрямую через CFFI без libheif-sys

3. **Сборка libheif из исходников**
   - Скомпилировать libheif локально с определенными флагами
   - Использовать локально скомпилированную версию вместо vcpkg

4. **Использование другого инструмента**
   - ImageMagick с поддержкой HEIC
   - FFmpeg для конвертации HEIC → JPG

5. **Статическая линковка с полным встраиванием**
   - Убедиться, что все зависимости (libde265, libjpeg) полностью встроены
   - Проверить, что нет динамических зависимостей

6. **Отключение функций libheif**
   - Может быть некоторые features включают динамическую загрузку
   - Попробовать минимальный набор features для декодирования

## Файлы для исследования

- `src/main.rs` - основной код, функции `extract_metadata_from_heif()` и `decode_heif_to_image()`
- `Cargo.toml` - конфигурация libheif-sys
- `.cargo/config.toml` - переменные окружения для vcpkg
- `target/release/photomap_processor.exe` (с feature heif) - скомпилированный бинарник для тестирования

## Тестовые HEIC-файлы

Находятся в `photos/`:
- `IMG_0279.HEIC` - содержит GPS (36°42'18.23..., 30°34'25.69...)
- `IMG_0280.HEIC` - содержит GPS (аналогичный диапазон)

Windows корректно читает GPS из обоих файлов через Properties.

## Следующие шаги для исследователя

1. Проверить, работает ли `heif_context_alloc()` напрямую (может потребоваться минимальный C-тест)
2. Изучить `libheif-sys` build script на GitHub
3. Проверить есть ли известные issues про Windows и LoadLibraryA error: 193
4. Попробовать скомпилировать libheif 1.20.2 с определенными флагами
5. Проверить, может ли быть проблема в том, что libde265 требует определенное API окружения

---

**Автор**: GitHub Copilot  
**Дата**: 14 ноября 2025  
**Статус**: Требуется дополнительное исследование на уровне libheif-sys/libde265
