
fn main() -> Result<()> {
    println!("üó∫Ô∏è  PhotoMap Processor –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...");

    // 0. –°–æ–∑–¥–∞–µ–º map.html –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
    if !std::path::Path::new(MAP_HTML_FILE).exists() {
        println!("üìÑ –°–æ–∑–¥–∞—é map.html...");
        create_map_html()?;
        println!("‚úÖ map.html —Å–æ–∑–¥–∞–Ω –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {}", MAP_HTML_FILE);
    } else {
        println!("üìÑ map.html —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {}", MAP_HTML_FILE);
    }

    // 1. –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
    fs::create_dir_all(THUMBNAIL_DIR)
        .with_context(|| format!("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä: {}", THUMBNAIL_DIR))?;

    // 2. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –≤ —Ç–µ–∫—É—â–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ –∏ –ø–æ–¥–ø–∞–ø–∫–∞—Ö
    println!("üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ –ø–æ–¥–ø–∞–ø–æ–∫...");
    let current_dir = std::env::current_dir()?;
    println!("üìÇ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {}", current_dir.display());

    // –°–æ–∑–¥–∞–µ–º walker –¥–ª—è —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º
    let walker = Walk::new(&current_dir);
    let files: Vec<PathBuf> = walker
        .into_iter()
        .filter_map(|entry| entry.ok())
        .filter(|e| {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏–ª–∏ –µ–µ –ø–æ–¥–ø–∞–ø–∫–∞—Ö
            e.path().starts_with(&current_dir)
        })
        .filter(|e| {
            // –ò—Å–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ —Å–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã
            let path = e.path();
            if let Some(components) = path.components().collect::<Vec<_>>().get(1..) {
                for component in components {
                    if let Some(name) = component.as_os_str().to_str() {
                        if name.starts_with('.') || name == "node_modules" || name == "target" || name == ".git" {
                            return false;
                        }
                    }
                }
            }
            true
        })
        .filter(|e| e.file_type().map_or(false, |ft| ft.is_file()))
        .map(|e| e.into_path())
        .collect();
    println!("‚úÖ –ù–∞–π–¥–µ–Ω–æ {} —Ñ–∞–π–ª–æ–≤ –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏. –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É...", files.len());

    // 3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –ø–æ–º–æ—â—å—é Rayon
    let photo_data: Vec<ImageMetadata> = files
        .par_iter() // <-- –ú–∞–≥–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞!
        .filter_map(|path| process_file(path).ok()) // –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
        .collect();

    println!("‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞–π–¥–µ–Ω–æ {} —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å GPS-–¥–∞–Ω–Ω—ã–º–∏.", photo_data.len());

    // 4. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ geodata.js
    write_geodata_js(&photo_data)?;
